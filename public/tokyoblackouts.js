Ext.ns("BO");BO.Data={groups:5,zeroDay:new Date(2011,2,15),dataSource:[["他の検索サイト（ITmedia）","http://www.itmedia.co.jp/news/articles/1103/15/news066.html","2011/03/18"],["計画停電情報（東京電力）","http://www.tepco.co.jp/index-j.html","2011/03/21"],["栃木県（東京電力、Excel形式）","http://www.tepco.co.jp/images/tochigi.xls","2011/03/19"],["茨城県（東京電力、Excel形式）","http://www.tepco.co.jp/images/ibaraki.xls","2011/03/16"],["群馬県（東京電力、Excel形式）","http://www.tepco.co.jp/images/gunma.xls","2011/03/19"],["千葉県（東京電力、Excel形式）","http://www.tepco.co.jp/images/chiba.xls","2011/03/20"],["神奈川県（東京電力、Excel形式）","http://www.tepco.co.jp/images/kanagawa.xls","2011/03/20"],["東京都（東京電力、Excel形式）","http://www.tepco.co.jp/images/tokyo.xls","2011/03/20"],["埼玉県（東京電力、Excel形式）","http://www.tepco.co.jp/images/saitama.xls","2011/03/18"],["山梨県（東京電力、Excel形式）","http://www.tepco.co.jp/images/yamanashi.xls","2011/03/19"],["静岡県（東京電力、Excel形式）","http://www.tepco.co.jp/images/numazu.xls","2011/03/18"]],slots:["18:20-22:00","15:20-19:00","12:20-16:00","09:20-13:00","06:20-10:00"],slots2:["16:50-20:30","13:50-17:30"],zeroDaySlots:[1,0,4,3,2],zeroDaySlots2:[3,2,1,0,4],getDaySlot:function(e,b){var f=b.getDayOfYear()-this.zeroDay.getDayOfYear(),a=this.zeroDaySlots[e],c=this.groups,d=(f+a)%c;return this.slots[d]},getDaySlot2:function(e,b){var f=b.getDayOfYear()-this.zeroDay.getDayOfYear(),a=this.zeroDaySlots2[e],c=this.groups,d=(f+a)%c;return this.slots2[d]||null},getSlot:function(f){var l=new Date(Math.max(new Date(),this.zeroDay)),h=[],m,e,c,k=[];for(var a=0;a<f.length;a++){for(var b=0;b<this.groups;b++){m=l.add(Date.DAY,b);e=this.getDaySlot(f[a]-1,m);c=this.getDaySlot2(f[a]-1,m);h.push({day:m,slot:e+(c?" & "+c:"")})}k.push({group:f[a],slots:h});h=[]}return k}};Ext.ns("BO");BO.Info=Ext.extend(Ext.Panel,{tpl:['<div class="boinfo">','<span class="add">住所：{address}</span><br>','<span id="timezone">時間帯：</span>',"<ul>",'<tpl for="detail">','<li class="h2s">グループ：{group}</li>','<ul class="rabox">','<tpl for="slots">','<li>{day:date("m/d")}:{slot}</li>',"</tpl>","</ul>","</tpl>","</ul>",'<a target="_blank" href="http://www.tepco.co.jp/cc/press/index11-j.html">詳細は東京電力のサイトをご確認ください</a>',"</div>"].join(""),scroll:"vertical",initComponent:function(){this.dockedItems=[{dock:"top",xtype:"toolbar",title:"詳細",items:[{xtype:"button",ui:"back",text:"地図",handler:this.onBack,scope:this}]}];this.addEvents("back");BO.Info.superclass.initComponent.call(this)},onBack:function(){this.fireEvent("back",this)}});Ext.reg("boinfo",BO.Info);Ext.ns("BO");BO.Source=Ext.extend(Ext.Panel,{viewTpl:'<div><tpl for="."><div class="bodetail"><a href="{url}" target="_blank" class="url">{pref}</a><br><span class="update">最終更新日：{update:date("Y/m/d")}</span></div></tpl></div>',viewSelector:"div.bodetail",initComponent:function(){this.layout="fit";this.dockedItems=[{dock:"top",xtype:"toolbar",title:"情報源"}];this.items=[{xtype:"dataview",tpl:this.viewTpl,itemSelector:this.viewSelector,store:this.store}];BO.Source.superclass.initComponent.call(this)}});Ext.reg("bosource",BO.Source);Ext.ns("BO");BO.Notice=Ext.extend(Ext.Panel,{modal:true,floating:true,centered:true,width:300,height:250,scroll:"vertical",styleHtmlContent:true,tpl:['<div class="bonotice">',"<span>住所：</span>","<ul>","<li>{address}</li>","</ul>","<span>今日の予定：</span>","<ul>",'<tpl for="group">',"<li>グループ{group}：{slot}</li>","</tpl>","</ul>","</div>"].join(""),scroll:"vertical",initComponent:function(){this.dockedItems=[{dock:"top",xtype:"toolbar",title:(new Date()).format("n月j日"),items:[{xtype:"spacer"},{text:"閉じる",handler:this.onClose,scope:this}]}];BO.Notice.superclass.initComponent.call(this)},onClose:function(){this.destroy()}});Ext.reg("bonotice",BO.Notice);Ext.ns("BO");BO.Map=Ext.extend(Ext.Panel,{initComponent:function(){this.layout="fit";this.items=[{xtype:"map",mapOptions:{zoom:15,mapTypeControl:false,streetViewControl:false}}];this.dockedItems=[{xtype:"toolbar",dock:"top",defaults:{ui:"plain",iconMask:true},items:[{xtype:"spacer"},{iconCls:"locate",handler:this.onLocate,scope:this}]}];BO.Map.superclass.initComponent.call(this);this.addEvents("addressfound","locationfound","groupfound","infowindowtap");this.map=this.down("map");this.onLocate()},onLocate:function(){var a=this.mask,c="現在地取得中";if(!a){a=this.mask=new Ext.LoadMask(Ext.getBody(),{msg:c})}else{c.msg}a.show();var b=this.geo;if(!b){b=this.geo=new Ext.util.GeoLocation({autoUpdate:false,timeout:30000})}b.updateLocation(this.onLocationUpdate,this)},onLocationUpdate:function(a){this.mask.hide();if(!a){alert("現在地が取得できませんでした。GPSがオフになっていませんか？地図上のピンを指で現在地に動かしてください。");a=new Ext.util.GeoLocation();a.longitude=139.75082825128175;a.latitude=35.68091903087664}this.setLocation(a);this.addMarker(a);this.fireEvent("locationfound",a);this.findAddress(a)},setLocation:function(a){var b=window.google.maps,d=new b.LatLng(a.latitude,a.longitude),c=this.map.map;c.setCenter(d)},addMarker:function(b){var d=this,c=window.google.maps,f=new c.LatLng(b.latitude,b.longitude),e=d.map.map,a=d.marker;if(!a){a=d.marker=new c.Marker({map:e,position:f,draggable:true,clickable:true});c.event.addListener(a,"click",function(){d.onMarkerClick.call(d)});c.event.addListener(a,"dragend",function(){d.onMarkerDragend.call(d)});c.event.addListener(a,"dragstart",function(){d.onMarkerDragstart.call(d)})}else{a.setPosition(f)}},onMarkerClick:function(){var d=this,c=window.google.maps,e=d.map.map,a=d.marker,f,b=this.iw;f=a.getPosition();b.setPosition(f);b.open(e,a)},onMarkerDragend:function(){var a=this.marker,b=a.getPosition();this.findAddress({latitude:b.lat(),longitude:b.lng()})},onMarkerDragstart:function(){if(this.iw){this.iw.close()}},findAddress:function(b){var d=this,c=window.google.maps,h=new c.LatLng(b.latitude,b.longitude),f=d.map.map,e=d.geocoder;var a=this.mask,g="詳細情報取得中";if(!a){a=this.mask=new Ext.LoadMask(Ext.getBody(),{msg:g})}else{a.msg=g}a.show();if(!e){e=d.geocoder=new c.Geocoder()}e.geocode({location:h},function(i){d.fireEvent("addressfound",i);d.onAddressFound.call(d,i)})},onAddressFound:function(f){var c=[],e,b="日本, ",g;if(Ext.isArray(f)&&f.length>0){for(var d=0,a=f.length;d<a;d++){e=f[d].formatted_address;g=e.indexOf(b);if(g>-1){c.push(e.slice(g+b.length))}}this.findGroup(c)}else{this.mask.hide();alert("住所の取得に失敗しました")}},findGroup:function(e){var c=window.google.maps,f=this.map.map,b=this.iw,a=this.marker,d;if(!b){b=this.iw=new c.InfoWindow({position:a.getPosition()})}Ext.Ajax.request({url:"search.json",params:{query:Ext.encode(e)},success:function(g){this.mask.hide();g=Ext.decode(g.responseText);if(g.group&&g.group.length>0){var h=new Ext.Element(document.createElement("div"));h.addCls("infowindow");h.dom.innerHTML=g.address+"<br/>グループ："+g.group.join(",");this.mon(h,"tapstart",function(){h.addCls("infowindow_pressed")});this.mon(h,"tap",function(){h.removeCls("infowindow_pressed");this.fireEvent("infowindowtap",this)},this);b.setContent(h.dom);b.open(f,a);this.fireEvent("groupfound",g.group,g.address)}else{alert("停電の範囲外かデータが存在しません")}},failure:function(g){this.mask.hide();alert("通信エラーです")},scope:this})}});Ext.reg("bomap",BO.Map);Ext.ns("BO");BO.App=Ext.extend(Ext.TabPanel,{notified:false,fullscreen:true,tabBar:{dock:"bottom",ui:"light",layout:{pack:"center"}},initComponent:function(){Ext.regModel("InfoSource",{fields:[{name:"pref"},{name:"url"},{name:"update",type:"date"}]});var a=new Ext.data.ArrayStore({model:"InfoSource",data:BO.Data.dataSource});this.items=[{xtype:"bomap",title:"地図",iconCls:"maps"},{xtype:"boinfo",title:"詳細",iconCls:"info"},{xtype:"bosource",title:"情報源",iconCls:"action",store:a},{xtype:"panel",scroll:"vertical",html:['<div class="tbhelp">','<h1 class="h2q">使い方１</h1>','<p class="howto box">ピンをドラッグドロップ（指で押さえて移動）することでその場所の住所と停電グループが分かります。</p>','<h1 class="h2q">使い方２</h1>','<p class="howto box">地図上の吹き出しに表示された文字をタップすることで時間帯情報が表示されます（または画面下の「詳細」アイコンをタップしてください。</p>','<h1 class="h2q">注意</h1>','<p class="caution box">地域により複数のグループが存在している場合があります。</p>','<h1 class="h2q">最終更新</h1>','<p class="update box">2011/03/21 22:55</p>',"</div>"].join(""),iconCls:"more",dockedItems:[{xtype:"toolbar",dock:"top",title:"使い方"}],title:"使い方"},{xtype:"panel",scroll:"vertical",html:['<div class="tbteam">','<h1 class="h2q">Team</h1>','<ul class="rabox">',"<li>@bossyooann</li>","<li>@kabaken</li>","<li>@kotsutsumi</li>","<li>@naotori</li>","</ul><br>",'<h1 class="h2q">Special Thanks to</h1>','<p class="box">さくらインターネット</p>','<h1 class="h2q">Contact</h1>','<p class="box">表示データに不具合、間違いがございましたら、@naotoriまでTwitterでご連絡ください</p>',"</div>"].join(""),iconCls:"team",dockedItems:[{xtype:"toolbar",dock:"top",title:"チーム"}],title:"チーム"}];BO.App.superclass.initComponent.call(this);this.info=this.down("boinfo");this.map=this.down("bomap");this.map.on({groupfound:this.onGroupFound,infowindowtap:this.onInfoWindowTap,scope:this});this.info.on({back:function(){this.setActiveItem(0,{type:"slide",direction:"right"})},scope:this})},onGroupFound:function(f,c){var j=BO.Data.getSlot(f),b=j.length,d=[],e,h;this.info.update({address:c,detail:j});if(this.notified===false){for(e=0;e<b;e++){d.push({group:j[e].group,slot:j[e].slots[0].slot})}h=new BO.Notice();h.update({address:c,group:d});h.show("pop");this.notified=true}},onInfoWindowTap:function(){this.setActiveItem(1)}});Ext.setup({fullscreen:true,icon:"icon.png",onReady:function(){new BO.App()}});